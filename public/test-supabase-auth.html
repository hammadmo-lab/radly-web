<!DOCTYPE html>
<html>
<head>
    <title>Supabase Auth Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Supabase Auth Debug</h1>

    <div>
        <h2>Current Session</h2>
        <pre id="sessionInfo">No session</pre>
    </div>

    <div>
        <h2>OAuth Providers Status</h2>
        <button onclick="checkGoogleOAuth()">Test Google OAuth</button>
        <button onclick="checkAppleOAuth()">Test Apple OAuth</button>
        <pre id="oauthInfo">Click a button to test OAuth</pre>
    </div>

    <div>
        <h2>Manual OAuth Test</h2>
        <button onclick="testGoogleOAuth()">Start Google OAuth</button>
        <button onclick="testAppleOAuth()">Start Apple OAuth</button>
        <pre id="manualOAuthResult">Ready to test</pre>
    </div>

    <script>
        // Initialize Supabase first
        const supabaseUrl = 'https://bsldtgivgtyzacwyvcfh.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzbGR0Z2l2Z3R5emFjd3l2Y2ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MzQ1NzMsImV4cCI6MjA3NTUxMDU3M30.vjHPo6WEASxYBOAGYmZ93o5n9RhZvANSlLhaT-wagTs'

        const supabase = createClient(supabaseUrl, supabaseAnonKey, {
            auth: {
                detectSessionInUrl: true,
                persistSession: true
            }
        })

        // Check current session
        async function checkSession() {
            const { data: { session }, error } = await supabase.auth.getSession()
            document.getElementById('sessionInfo').textContent = JSON.stringify({ session, error }, null, 2)
        }

        async function checkGoogleOAuth() {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'http://localhost:3000/auth/callback',
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent',
                        },
                    },
                })
                document.getElementById('oauthInfo').textContent = `Google OAuth: ${error ? error.message : 'Redirect initiated'}`
            } catch (err) {
                document.getElementById('oauthInfo').textContent = `Google OAuth Error: ${err.message}`
            }
        }

        async function checkAppleOAuth() {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'apple',
                    options: {
                        redirectTo: 'http://localhost:3000/auth/callback',
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent',
                        },
                    },
                })
                document.getElementById('oauthInfo').textContent = `Apple OAuth: ${error ? error.message : 'Redirect initiated'}`
            } catch (err) {
                document.getElementById('oauthInfo').textContent = `Apple OAuth Error: ${err.message}`
            }
        }

        async function testGoogleOAuth() {
            document.getElementById('manualOAuthResult').textContent = 'Testing Google OAuth...'
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: `${window.location.origin}/auth/callback`,
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent',
                        },
                    },
                })
                if (error) {
                    document.getElementById('manualOAuthResult').textContent = `Error: ${error.message}\n\nFull error: ${JSON.stringify(error, null, 2)}`
                } else {
                    document.getElementById('manualOAuthResult').textContent = 'OAuth redirect started. Check if you are redirected to Google...'
                }
            } catch (err) {
                document.getElementById('manualOAuthResult').textContent = `Exception: ${err.message}\n\n${err.stack}`
            }
        }

        async function testAppleOAuth() {
            document.getElementById('manualOAuthResult').textContent = 'Testing Apple OAuth...'
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'apple',
                    options: {
                        redirectTo: `${window.location.origin}/auth/callback`,
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent',
                        },
                    },
                })
                if (error) {
                    document.getElementById('manualOAuthResult').textContent = `Error: ${error.message}\n\nFull error: ${JSON.stringify(error, null, 2)}`
                } else {
                    document.getElementById('manualOAuthResult').textContent = 'OAuth redirect started. Check if you are redirected to Apple...'
                }
            } catch (err) {
                document.getElementById('manualOAuthResult').textContent = `Exception: ${err.message}\n\n${err.stack}`
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check session on load
            checkSession()

            // Listen for auth state changes
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state change:', event, session)
                document.getElementById('sessionInfo').textContent = JSON.stringify({ event, session }, null, 2)
            })

            // Check URL parameters on load
            const urlParams = new URLSearchParams(window.location.search)
            if (urlParams.get('code') || urlParams.get('error')) {
                document.getElementById('manualOAuthResult').textContent = `OAuth callback detected!\nURL: ${window.location.href}\nParams: ${JSON.stringify(Object.fromEntries(urlParams.entries()), null, 2)}`
            }
        })
    </script>
</body>
</html>